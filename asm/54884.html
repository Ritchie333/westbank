<!DOCTYPE html>
<html>
<head>
<title>West Bank: Routine at D664</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../westbank.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54814.html">D61E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54884">Map</a></td>
<td class="next">
Next: <a href="55070.html">D71E</a>
</td>
</tr>
</table>
<div class="description">D664: Draw Doors.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="52282.html">CC3A</a>, <a href="54415.html">D48F</a>, <a href="55070.html">D71E</a>, <a href="55237.html">D7C5</a>, <a href="55525.html">D8E5</a> and <a href="55820.html">DA0C</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54884"></span>
<div class="comments">
<div class="paragraph">
Preps door frame 1.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54884"></span>D664</td>
<td class="instruction">LD HL,$D6B1</td>
<td class="comment-1" rowspan="2">Calls <a href="54884.html#54916">D684</a> using <a href="54884.html#54961">D6B1</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54887"></span>D667</td>
<td class="instruction">CALL $D684</td>
</tr>
<tr>
<td class="address-1"><span id="54890"></span>D66A</td>
<td class="instruction">LD DE,$BA80</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=<a href="47744.html">BA80</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54893"></span>
<div class="comments">
<div class="paragraph">
Referencing the door frame index, work out the screen position and send it to the <a href="54884.html#55063">D717</a> routine.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54893"></span>D66D</td>
<td class="instruction">LD A,($CE1A)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="52762.html">CE1A</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54896"></span>D670</td>
<td class="instruction">LD HL,$4082</td>
<td class="comment-1" rowspan="8">Determines which screen address to use for the door reference index currently held in <span class="register">A</span>. <table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">Screen Address</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$01</td>
<td class="centre" colspan="1" rowspan="1">$4082</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$02</td>
<td class="centre" colspan="1" rowspan="1">$408D</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$03</td>
<td class="centre" colspan="1" rowspan="1">$4098</td>
</tr>
</table> Jump to <a href="54884.html#55063">D717</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54899"></span>D673</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="54900"></span>D674</td>
<td class="instruction">JP Z,$D717</td>
</tr>
<tr>
<td class="address-1"><span id="54903"></span>D677</td>
<td class="instruction">LD HL,$408D</td>
</tr>
<tr>
<td class="address-1"><span id="54906"></span>D67A</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="54907"></span>D67B</td>
<td class="instruction">JP Z,$D717</td>
</tr>
<tr>
<td class="address-1"><span id="54910"></span>D67E</td>
<td class="instruction">LD HL,$4098</td>
</tr>
<tr>
<td class="address-1"><span id="54913"></span>D681</td>
<td class="instruction">JP $D717</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54916"></span>
<div class="comments">
<div class="paragraph">
Copies attributes for the current door frame index.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54916"></span>D684</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Stash the accumulator for later.</td>
</tr>
<tr>
<td class="address-1"><span id="54917"></span>D685</td>
<td class="instruction">LD A,($CE1A)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="52762.html">CE1A</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54920"></span>D688</td>
<td class="instruction">LD DE,$5882</td>
<td class="comment-1" rowspan="7"><table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">Screen Address</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$01</td>
<td class="centre" colspan="1" rowspan="1">$5882</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$02</td>
<td class="centre" colspan="1" rowspan="1">$588D</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$03</td>
<td class="centre" colspan="1" rowspan="1">$5898</td>
</tr>
</table> ...continue from <a href="54884.html#54935">D697</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54923"></span>D68B</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="54924"></span>D68C</td>
<td class="instruction">JR Z,$D697</td>
</tr>
<tr>
<td class="address-1"><span id="54926"></span>D68E</td>
<td class="instruction">LD DE,$588D</td>
</tr>
<tr>
<td class="address-1"><span id="54929"></span>D691</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="54930"></span>D692</td>
<td class="instruction">JR Z,$D697</td>
</tr>
<tr>
<td class="address-1"><span id="54932"></span>D694</td>
<td class="instruction">LD DE,$5898</td>
</tr>
<tr>
<td class="address-2"><span id="54935"></span>D697</td>
<td class="instruction">LD B,$0B</td>
<td class="comment-1" rowspan="1">Sets the height of the door image.</td>
</tr>
<tr>
<td class="address-2"><span id="54937"></span>D699</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="4">Stash the references for later and call <a href="54884.html#54955">D6AB</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54938"></span>D69A</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="address-1"><span id="54939"></span>D69B</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="address-1"><span id="54940"></span>D69C</td>
<td class="instruction">CALL $D6AB</td>
</tr>
<tr>
<td class="address-1"><span id="54943"></span>D69F</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="4">Moves the screen attribute address down to the next attribute row.</td>
</tr>
<tr>
<td class="address-1"><span id="54944"></span>D6A0</td>
<td class="instruction">LD HL,$0020</td>
</tr>
<tr>
<td class="address-1"><span id="54947"></span>D6A3</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="54948"></span>D6A4</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="54949"></span>D6A5</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="3">Restore the counter and loop back to <a href="54884.html#54937">D699</a> until complete.</td>
</tr>
<tr>
<td class="address-1"><span id="54950"></span>D6A6</td>
<td class="instruction">POP BC</td>
</tr>
<tr>
<td class="address-1"><span id="54951"></span>D6A7</td>
<td class="instruction">DJNZ $D699</td>
</tr>
<tr>
<td class="address-1"><span id="54953"></span>D6A9</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="2">Restore the accumulator and return.</td>
</tr>
<tr>
<td class="address-1"><span id="54954"></span>D6AA</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54955"></span>
<div class="comments">
<div class="paragraph">
Simple helper copy routine for sending attribute data to the screen attribute buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54955"></span>D6AB</td>
<td class="instruction">LD BC,$0007</td>
<td class="comment-1" rowspan="3">Set the door width, copy the attribute data to the screen and return.</td>
</tr>
<tr>
<td class="address-1"><span id="54958"></span>D6AE</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="54960"></span>D6B0</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54961"></span>
<div class="comments">
<div class="paragraph">
Door frame attribute data.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="54961"></span>D6B1</td>
<td class="instruction">DEFB $30,$30,$30,$30,$30,$30,$30,$30</td>
<td class="comment-1" rowspan="1">Attribute data for door frame 1.</td>
</tr>
<tr>
<td class="address-1"><span id="54969"></span>D6B9</td>
<td class="instruction">DEFB $28,$28,$30,$30,$30,$30,$30,$30</td>
<td class="comment-1" rowspan="1">Attribute data for door frame 2.</td>
</tr>
<tr>
<td class="address-1"><span id="54977"></span>D6C1</td>
<td class="instruction">DEFB $28,$28,$28,$28,$30,$30,$30,$30</td>
<td class="comment-1" rowspan="1">Attribute data for door frame 3.</td>
</tr>
<tr>
<td class="address-1"><span id="54985"></span>D6C9</td>
<td class="instruction">DEFB $28,$28,$28,$28,$28,$28,$30,$28</td>
<td class="comment-1" rowspan="1">Attribute data for door frame 4.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54993"></span>
<div class="comments">
<div class="paragraph">
Preps door frame 2.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54993"></span>D6D1</td>
<td class="instruction">LD HL,$D6B9</td>
<td class="comment-1" rowspan="2">Calls <a href="54884.html#54916">D684</a> using <a href="54884.html#54969">D6B9</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="54996"></span>D6D4</td>
<td class="instruction">CALL $D684</td>
</tr>
<tr>
<td class="address-1"><span id="54999"></span>D6D7</td>
<td class="instruction">CALL <a href="54814.html">$D61E</a></td>
<td class="comment-1" rowspan="3">Prepare the character/ door image by calling <a href="54814.html">D61E</a>. Then pass <a href="60048.html">EA90</a> to <a href="54884.html#54893">D66D</a> which will draw it to the screen.</td>
</tr>
<tr>
<td class="address-1"><span id="55002"></span>D6DA</td>
<td class="instruction">LD DE,$EA90</td>
</tr>
<tr>
<td class="address-1"><span id="55005"></span>D6DD</td>
<td class="instruction">JR $D66D</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="55007"></span>
<div class="comments">
<div class="paragraph">
Preps door frame 3.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="55007"></span>D6DF</td>
<td class="instruction">LD HL,$D6C1</td>
<td class="comment-1" rowspan="2">Calls <a href="54884.html#54916">D684</a> using <a href="54884.html#54977">D6C1</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="55010"></span>D6E2</td>
<td class="instruction">CALL $D684</td>
</tr>
<tr>
<td class="address-1"><span id="55013"></span>D6E5</td>
<td class="instruction">CALL <a href="54814.html#54840">$D638</a></td>
<td class="comment-1" rowspan="3">Prepare the character/ door image by calling <a href="54814.html#54840">D638</a>. Then pass <a href="60048.html">EA90</a> to <a href="54884.html#54893">D66D</a> which will draw it to the screen.</td>
</tr>
<tr>
<td class="address-1"><span id="55016"></span>D6E8</td>
<td class="instruction">LD DE,$EA90</td>
</tr>
<tr>
<td class="address-1"><span id="55019"></span>D6EB</td>
<td class="instruction">JR $D66D</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="55021"></span>
<div class="comments">
<div class="paragraph">
Preps door frame 4.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="55021"></span>D6ED</td>
<td class="instruction">LD HL,$D6C9</td>
<td class="comment-1" rowspan="2">Calls <a href="54884.html#54916">D684</a> using <a href="54884.html#54985">D6C9</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="55024"></span>D6F0</td>
<td class="instruction">CALL $D684</td>
</tr>
<tr>
<td class="address-1"><span id="55027"></span>D6F3</td>
<td class="instruction">CALL <a href="54730.html">$D5CA</a></td>
<td class="comment-1" rowspan="1">The door is fully open so draw the whole character in the doorway directly.</td>
</tr>
<tr>
<td class="address-1"><span id="55030"></span>D6F6</td>
<td class="instruction">LD B,$58</td>
<td class="comment-1" rowspan="3">Reference <a href="49064.html">BFA8</a> and the dimensions for the copy routine.</td>
</tr>
<tr>
<td class="address-1"><span id="55032"></span>D6F8</td>
<td class="instruction">LD C,$01</td>
</tr>
<tr>
<td class="address-1"><span id="55034"></span>D6FA</td>
<td class="instruction">LD DE,$BFA8</td>
</tr>
<tr>
<td class="address-1"><span id="55037"></span>D6FD</td>
<td class="instruction">LD A,($CE1A)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="52762.html">CE1A</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="55040"></span>D700</td>
<td class="instruction">LD HL,$4088</td>
<td class="comment-1" rowspan="8">Determines which screen address to use for the door reference index currently held in <span class="register">A</span>. <table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">Screen Address</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$01</td>
<td class="centre" colspan="1" rowspan="1">$4088</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$02</td>
<td class="centre" colspan="1" rowspan="1">$4093</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$03</td>
<td class="centre" colspan="1" rowspan="1">$409E</td>
</tr>
</table> Jump to <a href="54758.html">D5E6</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="55043"></span>D703</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="55044"></span>D704</td>
<td class="instruction">JP Z,<a href="54758.html">$D5E6</a></td>
</tr>
<tr>
<td class="address-1"><span id="55047"></span>D707</td>
<td class="instruction">LD HL,$4093</td>
</tr>
<tr>
<td class="address-1"><span id="55050"></span>D70A</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="address-1"><span id="55051"></span>D70B</td>
<td class="instruction">JP Z,<a href="54758.html">$D5E6</a></td>
</tr>
<tr>
<td class="address-1"><span id="55054"></span>D70E</td>
<td class="instruction">LD HL,$409E</td>
</tr>
<tr>
<td class="address-1"><span id="55057"></span>D711</td>
<td class="instruction">JP <a href="54758.html">$D5E6</a></td>
</tr>
<tr>
<td class="address-1"><span id="55060"></span>D714</td>
<td class="instruction">LD DE,$EA90</td>
<td class="comment-1" rowspan="1"><span class="register">DE</span>=<a href="60048.html">EA90</a>.</td>
</tr>
<tr>
<td class="address-2"><span id="55063"></span>D717</td>
<td class="instruction">LD B,$58</td>
<td class="comment-1" rowspan="3">Draws the image pointed at by <span class="register">DE</span> to the screen address in <span class="register">HL</span> using <a href="54758.html">D5E6</a>.</td>
</tr>
<tr>
<td class="address-1"><span id="55065"></span>D719</td>
<td class="instruction">LD C,$07</td>
</tr>
<tr>
<td class="address-1"><span id="55067"></span>D71B</td>
<td class="instruction">JP <a href="54758.html">$D5E6</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54814.html">D61E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54884">Map</a></td>
<td class="next">
Next: <a href="55070.html">D71E</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; DINAMIC SOFTWARE 1985</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>